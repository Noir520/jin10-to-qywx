name: Jin10 RSS to QY WeChat

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

concurrency:
  group: jin10-rss
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: bot/update-last
          fetch-depth: 0

      # 确保 bot 分支存在并包含最新代码
      # Ensure bot branch exists and has latest code
      - name: Prepare bot branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 如果 bot 分支不存在，从 main 创建
          # If bot branch doesn't exist, create from main
          if ! git rev-parse --verify origin/bot/update-last >/dev/null 2>&1; then
            git checkout -b bot/update-last origin/main
            git push -u origin bot/update-last
          fi
          
          # 从 main 合并最新代码（仅代码文件，保留 last.json）
          # Merge latest code from main (keep last.json)
          git fetch origin main
          git checkout origin/main -- rss_to_qywx.js package.json package-lock.json README.md .github/workflows/rss.yml 2>/dev/null || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run RSS script
        env:
          RSS_URL: ${{ secrets.RSS_URL }}
          QYWX_WEBHOOK: ${{ secrets.QYWX_WEBHOOK }}
        run: node rss_to_qywx.js

      - name: Commit and push last.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last.json
          git diff --staged --quiet || git commit -m "chore: update last.json [skip ci]"
          git push origin bot/update-last
